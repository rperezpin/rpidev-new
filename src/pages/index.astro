---
import Layout from '../layouts/Layout.astro';
import Nav from '../components/Nav.astro';
import Footer from '../components/Footer.astro';
import Hero from '../components/sections/Hero.astro';
import Problem from '../components/sections/Problem.astro';
import Services from '../components/sections/Services.astro';
import Plan from '../components/sections/Plan.astro';
import Portfolio from '../components/sections/Portfolio.astro';
import Contact from '../components/sections/Contact.astro';
---

<Layout
  title="RPI Dev | Desarrollo Web y Automatización en Granada"
  description="Desarrollo web profesional en Granada. Soluciones digitales para autónomos y pequeñas empresas. Especializado en rendimiento y experiencia de usuario."
>
  <!-- Gradiente dinámico que sigue el cursor -->
  <div id="mouse-gradient" class="fixed inset-0 pointer-events-none z-0"></div>
  <div class="fixed -top-[20%] -left-[10%] w-[60%] h-[60%] bg-blue-700/8 blur-[120px] rounded-full pointer-events-none"></div>

  <Nav />

  <main
    id="scroll-container"
    class="relative overflow-hidden w-screen h-screen z-10"
  >
    <div id="scroll-wrapper">
      <Hero />
      <Problem />
      <Services />
      <Plan />
      <Portfolio />
      <Contact />
    </div>
  </main>

  <Footer />

  <!-- Indicador de dirección de scroll (solo mobile) -->
  <div id="scroll-indicator" class="fixed bottom-14 left-1/2 -translate-x-1/2 z-40 md:hidden transition-opacity duration-300">
    <div class="w-8 h-8 rounded-full bg-white/10 backdrop-blur-sm border border-white/10 flex items-center justify-center scroll-indicator-bounce">
      <svg id="scroll-arrow" class="w-4 h-4 text-white/60 transition-transform duration-300" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
        <path d="M9 5l7 7-7 7" />
      </svg>
    </div>
  </div>

  <!-- Navegación 2D tipo serpiente: gradiente dinámico + transiciones entre secciones -->
  <script>
    function initScrollEffects() {
      const w = window as typeof window & { __scrollEffectsInitialized?: boolean };
      if (w.__scrollEffectsInitialized) return;
      w.__scrollEffectsInitialized = true;

      const gradient = document.getElementById('mouse-gradient');
      const container = document.getElementById('scroll-container');
      const wrapper = document.getElementById('scroll-wrapper');
      if (!container || !wrapper) return;

      const getViewportHeight = () => (window.visualViewport ? window.visualViewport.height : window.innerHeight);
      let viewportWidth = window.innerWidth;
      let viewportHeight = getViewportHeight();

      function updateViewportVars() {
        viewportWidth = window.innerWidth;
        viewportHeight = getViewportHeight();
        document.documentElement.style.setProperty('--vw', `${viewportWidth * 0.01}px`);
        document.documentElement.style.setProperty('--vh', `${viewportHeight * 0.01}px`);
      }

      function applyTransform(index: number) {
        const pos = POSITIONS[index];
        wrapper.style.transform = `translate(${-pos.col * viewportWidth}px, ${-pos.row * viewportHeight}px)`;
      }

      // Posiciones de cada sección en la cuadrícula 2D (col, row)
      // Layout serpiente:
      //   [0:Hero]  →  [1:Problem]
      //                     ↓
      //   [3:Plan]  ←  [2:Services]
      //      ↓
      //   [4:Portfolio] → [5:Contact]
      const POSITIONS = [
        { col: 0, row: 0 },
        { col: 1, row: 0 },
        { col: 1, row: 1 },
        { col: 0, row: 1 },
        { col: 0, row: 2 },
        { col: 1, row: 2 },
      ];

      // Dirección de transición de sección i a i+1
      const DIRECTIONS = ['right', 'down', 'left', 'down', 'right'];

      let currentSection = 0;
      let isTransitioning = false;

      updateViewportVars();
      applyTransform(currentSection);
      window.addEventListener('resize', () => {
        updateViewportVars();
        applyTransform(currentSection);
      });
      if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', () => {
          updateViewportVars();
          applyTransform(currentSection);
        });
      }

      // Gradiente que sigue el mouse
      if (gradient) {
        document.addEventListener('mousemove', (e) => {
          gradient.style.background = `radial-gradient(800px circle at ${e.clientX}px ${e.clientY}px, rgba(37, 99, 235, 0.06), transparent 80%)`;
        });
      }

      function navigateTo(index: number) {
        if (!wrapper || index < 0 || index >= POSITIONS.length || index === currentSection || isTransitioning) return;

        isTransitioning = true;
        const prevSection = currentSection;
        currentSection = index;

        // Mover el wrapper a la posición de la sección destino
        updateViewportVars();
        applyTransform(index);

        // Ocultar contenido de la sección anterior
        const prevContent = document.querySelector(`.section[data-index="${prevSection}"] .section-content`);
        if (prevContent) {
          prevContent.classList.add('section-hidden');
          prevContent.classList.remove('section-visible');
        }

        // Mostrar contenido de la nueva sección tras breve pausa
        setTimeout(() => {
          const newContent = document.querySelector(`.section[data-index="${index}"] .section-content`);
          if (newContent) {
            newContent.classList.add('section-visible');
            newContent.classList.remove('section-hidden');
          }
        }, 300);

        // Actualizar indicador de dirección (mobile)
        updateScrollIndicator(index);

        // Notificar cambio de sección (para Nav y otros)
        window.dispatchEvent(new CustomEvent('section-change', { detail: { index } }));

        // Permitir siguiente transición tras completar animación
        setTimeout(() => { isTransitioning = false; }, 800);
      }

      // Rotaciones del chevron según dirección: right=0, down=90, left=180
      const ARROW_ROTATIONS: Record<string, string> = { right: '0', down: '90', left: '180' };

      function updateScrollIndicator(sectionIndex: number) {
        const indicator = document.getElementById('scroll-indicator');
        const arrow = document.getElementById('scroll-arrow');
        if (!indicator || !arrow) return;

        if (sectionIndex >= POSITIONS.length - 1) {
          indicator.style.opacity = '0';
        } else {
          indicator.style.opacity = '1';
          const dir = DIRECTIONS[sectionIndex];
          arrow.style.transform = `rotate(${ARROW_ROTATIONS[dir]}deg)`;
        }
      }

      // Exponer navegación globalmente
      window.navigateToSection = navigateTo;
      window.getCurrentSection = () => currentSection;

      if (container) {
        // Navegación con rueda del ratón (desktop)
        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

        if (!isTouchDevice) {
          container.addEventListener('wheel', (e) => {
            e.preventDefault();
            const direction = e.deltaY > 0 ? 1 : -1;
            navigateTo(currentSection + direction);
          }, { passive: false });
        }

        // Navegación táctil (mobile)
        let touchStartX = 0;
        let touchStartY = 0;
        let touchStartTarget: EventTarget | null = null;

        container.addEventListener('touchstart', (e) => {
          touchStartX = e.touches[0].clientX;
          touchStartY = e.touches[0].clientY;
          touchStartTarget = e.target;
        }, { passive: true });

        container.addEventListener('touchend', (e) => {
          const scrollableTarget = touchStartTarget instanceof Element
            ? touchStartTarget.closest('[data-scrollable]')
            : null;
          if (scrollableTarget instanceof HTMLElement) {
            const canScroll = scrollableTarget.scrollHeight - scrollableTarget.clientHeight > 2;
            if (canScroll) return;
          }

          const dx = e.changedTouches[0].clientX - touchStartX;
          const dy = e.changedTouches[0].clientY - touchStartY;
          const absDx = Math.abs(dx);
          const absDy = Math.abs(dy);

          if (Math.max(absDx, absDy) < 80) return;

          let forward = false;
          let backward = false;

          // Swipe hacia adelante según la dirección de transición actual
          if (currentSection < POSITIONS.length - 1) {
            const dir = DIRECTIONS[currentSection];
            if (dir === 'right' && absDx > absDy && dx < -80) forward = true;
            if (dir === 'down' && absDy > absDx && dy < -80) forward = true;
            if (dir === 'left' && absDx > absDy && dx > 80) forward = true;
          }

          // Swipe hacia atrás según la dirección de transición previa
          if (currentSection > 0) {
            const dir = DIRECTIONS[currentSection - 1];
            if (dir === 'right' && absDx > absDy && dx > 80) backward = true;
            if (dir === 'down' && absDy > absDx && dy > 80) backward = true;
            if (dir === 'left' && absDx > absDy && dx < -80) backward = true;
          }

          if (forward && !isTransitioning) navigateTo(currentSection + 1);
          else if (backward && !isTransitioning) navigateTo(currentSection - 1);
        });
      }

      // Inicializar: ocultar todos los contenidos y mostrar el primero
      document.querySelectorAll('.section .section-content').forEach((content) => {
        content.classList.add('section-hidden');
      });

      setTimeout(() => {
        const firstContent = document.querySelector('.section[data-index="0"] .section-content');
        if (firstContent) {
          firstContent.classList.add('section-visible');
          firstContent.classList.remove('section-hidden');
        }
      }, 200);
    }

    document.addEventListener('astro:page-load', initScrollEffects);
    initScrollEffects();
  </script>
</Layout>
