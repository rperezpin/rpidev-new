---
const sections = ['INICIO', 'PROBLEMA', 'SERVICIOS', 'PLAN', 'PORTFOLIO', 'CONTACTO'];
---

<nav id="site-nav" class="fixed top-0 left-0 w-full px-4 py-3 md:px-8 md:py-6 z-50 flex justify-between items-center">
  <button
    id="nav-logo"
    class="flex items-center gap-2 group cursor-pointer bg-transparent border-none"
    data-section="0"
    aria-label="Ir al inicio"
  >
    <img
      src="/logo_blanco.webp"
      alt="RPI Dev"
      class="h-20 md:h-22 w-auto group-hover:scale-105 transition-transform duration-300"
    />
  </button>

  <!-- Nav desktop -->
  <div class="hidden md:flex gap-1 bg-white/5 backdrop-blur-xl p-1 rounded-full border border-white/10">
    {sections.map((name, idx) => (
      <button
        class="nav-btn px-4 py-2 rounded-full text-[10px] font-bold tracking-widest transition-all text-slate-400 hover:bg-white/5"
        data-section={idx}
      >
        {name}
      </button>
    ))}
  </div>

  <!-- Nav mobile: dots -->
  <div class="flex md:hidden gap-1.5 bg-white/5 backdrop-blur-xl px-3 py-2 rounded-full border border-white/10">
    {sections.map((_name, idx) => (
      <button
        class="nav-btn w-6 h-6 rounded-full text-[9px] font-bold transition-all text-slate-500 hover:bg-white/5 flex items-center justify-center"
        data-section={idx}
        aria-label={sections[idx]}
      >
        {(idx + 1).toString()}
      </button>
    ))}
  </div>
</nav>

<script>
  function initNav() {
    const w = window as typeof window & { __navInitialized?: boolean };
    if (w.__navInitialized) return;
    w.__navInitialized = true;

    const buttons = document.querySelectorAll('.nav-btn, #nav-logo');
    const nav = document.getElementById('site-nav');

    function updateNavHeight() {
      if (!nav) return;
      const height = nav.getBoundingClientRect().height;
      document.documentElement.style.setProperty('--nav-h', `${height}px`);
    }

    updateNavHeight();
    window.addEventListener('resize', updateNavHeight);
    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', updateNavHeight);
    }
    if (document.fonts && document.fonts.ready) {
      document.fonts.ready.then(updateNavHeight).catch(() => {});
    }

    buttons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const section = parseInt(btn.getAttribute('data-section') || '0');
        if (window.navigateToSection) {
          window.navigateToSection(section);
        }
      });
    });

    function updateActive(index: number) {
      document.querySelectorAll('.nav-btn').forEach((btn, i) => {
        const idx = i % 6;
        if (idx === index) {
          btn.classList.add('bg-blue-600', 'text-white');
          btn.classList.remove('text-slate-400', 'text-slate-500', 'hover:bg-white/5');
        } else {
          btn.classList.remove('bg-blue-600', 'text-white');
          btn.classList.add('text-slate-400', 'hover:bg-white/5');
        }
      });
    }

    window.addEventListener('section-change', (e) => {
      updateActive((e as CustomEvent).detail.index);
    });

    updateActive(0);
  }

  document.addEventListener('astro:page-load', initNav);
  initNav();
</script>
